<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>实时语音转文字</title>
</head>
<body>

<h2>实时会议转写</h2>

<button onclick="startRecording()">开始</button>
<button onclick="pauseRecording()">暂停</button>

<div style="margin-top:20px;border:1px solid #ccc;padding:10px;height:200px;overflow:auto" id="result">
</div>

<script>

let socket;
let audioContext;
let processor;
let input;
let globalStream;
let recording = false;

const CHUNK_DURATION = 3000; // 3秒

async function startRecording() {

    if (recording) return;

    if (!socket || socket.readyState !== 1) {
        socket = new WebSocket("ws://localhost:8000/ws");

        socket.onmessage = (event) => {
            const div = document.getElementById("result");
            div.innerHTML += event.data + " ";
            div.scrollTop = div.scrollHeight;
        };
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    globalStream = stream;

    audioContext = new AudioContext({ sampleRate: 16000 });
    input = audioContext.createMediaStreamSource(stream);

    processor = audioContext.createScriptProcessor(4096, 1, 1);

    let buffer = [];

    processor.onaudioprocess = (e) => {

        if (!recording) return;

        const channelData = e.inputBuffer.getChannelData(0);
        buffer.push(new Float32Array(channelData));

    };

    input.connect(processor);
    processor.connect(audioContext.destination);

    recording = true;

    // 每3秒发送一次
    setInterval(() => {

        if (!recording || buffer.length === 0) return;

        let length = buffer.reduce((acc, cur) => acc + cur.length, 0);
        let merged = new Float32Array(length);

        let offset = 0;
        buffer.forEach(b => {
            merged.set(b, offset);
            offset += b.length;
        });

        buffer = [];

        socket.send(merged.buffer);

    }, CHUNK_DURATION);

}

function pauseRecording() {
    recording = false;
}

</script>

</body>
</html>
